<!DOCTYPE html>
<html>
	<head>
		<!-- load styles -->
		<style>{{d3css}}</style>
		<style>{{css}}</style>

		<!-- load javascript -->
		<script type='text/javascript'>{{js}}</script>


		<script type='text/javascript'>

			{{d3js}}

			function updateSharedParameters(){
				var shared_params = "";
				{% for field in shared_fields %}
					var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
					shared_params = shared_params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&";
					console.log(shared_params)
				{% endfor %}
				return shared_params;
			}

			// connect controller function to output functions
			{% for control in controls %}
				function {{control['control_name']}}(){
					{% for output in outputs %}
						{% if output['control_name']==control['control_name'] %}
							{{output['output_id']}}()
						{% endif %}
					{% endfor %}
				}
			{% endfor %}

			// define output functions
			{% for output in outputs %}
				{% if output['output_type']=='image' %}
					// load image function
					function {{output['output_id']}}(){
						$("#{{output['output_id']}}").empty();
						var params = updateSharedParameters();
						params = params+"output_id={{output['output_id']}}&";
						console.log(params);
						var plot = $("<img />").attr('src', "/plot?"+params)
						$("#{{output['output_id']}}").append(plot);
					}
				{% endif %}

				{% if output['output_type']=='html' %}
					// custom html function
					function {{output['output_id']}}(){
						var params = updateSharedParameters();
						params = params+"output_id={{output['output_id']}}&";
						$.ajax({
							url : "/html?"+params,
							success: function(response, textStatus, jqXHR){
								$("#{{output['output_id']}}").html(response);
							}
						});
					}
				{% endif %}

				{% if output['output_type']=='table' %}
					function {{output['output_id']}}(){
						updateSharedParameters()
						var params = updateSharedParameters();
						params = params+"output_id={{output['output_id']}}&";
						console.log('function executed')
						$.ajax({
							type: 'GET',
							url : "/table?"+params
						}).done(function(response){
								console.log('response')
								$("#{{output['output_id']}}").html(response);
								initTable("sortable");
							});
						;
					}
					
				{% endif %}

				{% if output['output_type']=='d3' %}
					function {{output['output_id']}}(){
						show_d3_plot()					
					}
				{% endif %}
			{% endfor %}

			// custom function for handling d3 plots
			function show_d3_plot(){
				var params = updateSharedParameters();
				$.ajax({
					url : "/data?"+params,
					success: function(response, textStatus, jqXHR)
					{	
						$("#chart").empty();
						var data = response.data;
						draw(data);
					}
				});
			};
			
			$(document).ready(function() {
				// jquery for tabs
				jQuery('.tabs .tab-links a').on('click', function(e)  {
					var currentAttrValue = jQuery(this).attr('href');

					// Show/Hide Tabs
					jQuery('.tabs ' + currentAttrValue).show().siblings().hide();

					// Change/remove current tab to active
					jQuery(this).parent('li').addClass('active').siblings().removeClass('active');

					e.preventDefault();
    			});

				// connect controller functions to controllers
				{% for control in controls %}
					$("#{{control['control_name']}}").click(function(e) {
						{{control['control_name']}}()
					});

				{% endfor %}

				{% for output in outputs %}
					// if on_page_load is true, load when page loads
					{% if output['on_page_load']=='true' %}
						{{output['output_id']}}()
					{% endif %}
				{% endfor %}

			});
		</script>
	</head>

	<body>
		<div class="outer">

		<!-- control panel -->
		<div class="left-panel">
			<h1>{{title}}</h1>
			<hr>
			{% for field in shared_fields %}
				{{field['label']}}: <input type="{{field['input_type']}}" value="{{field['value']}}" id="{{field['variable_name']}}" /><br>
			{% endfor %}

			{% for control in controls %}
				{% for field in control['text_fields'] %}
					{{field['label']}}: <input type="{{field['input_type']}}" value="{{field['value']}}" id="{{field['variable_name']}}" /><br>
				{% endfor %}

				<!-- buttons -->
				{% if control['control_type']=="button" %}
					<div class="button" id="{{control['control_name']}}" >{{control['button_label']}}</div><br>
				{% endif %}
			{% endfor %}
		</div>

		<!-- output -->
		<div class="right-panel">
			{% if tabs is defined %}
				<div class="tabs">
					<ul class="tab-links">
						{% for tab in tabs %}
							{% if loop.index == 1 %}
								<li class="active"><a href="#{{tab}}">{{tab}}</a></li>
							{% else %}
								<li><a href="#{{tab}}">{{tab}}</a></li>
							{% endif %}
						{% endfor %}
					</ul>

					<div class="tab-content">
						{% for tab in tabs %}
							{% if loop.index == 1 %}
								<div id="{{tab}}" class="tab active">
							{% else %}
								<div id="{{tab}}" class="tab">
							{% endif %}
							{% for output in outputs %}
								{% if output['tab'] == tab %}
									<!-- images, custom html, tables, anything not d3 -->
									{% if output['output_type'] != "d3" %}
										<div id="{{output['output_id']}}"></div>
									{% endif %}

									<!-- d3 figs go here -->
									{% if output['output_type'] == "d3" %}
										<div id="chart"></div>
									{% endif %}
								{% endif %}

							{% endfor %}
							</div>
						{% endfor %}

					</div>
				</div>
			{% else %}	

				{% for output in outputs %}
					<!-- images, custom html, tables, anything not d3 -->
					{% if output['output_type'] != "d3" %}
						<div id="{{output['output_id']}}"></div>
					{% endif %}

					<!-- d3 figs go here -->
					{% if output['output_type'] == "d3" %}
						<div id="chart"></div>
					{% endif %}
				{% endfor %}

			{% endif %}
		</div>
		</div>
		
	</body>
</html>

